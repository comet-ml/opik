# Custom values for Azure deployment
# This file uses environment variables from .env.azure
# Variables are substituted by the deployment script
#
# DO NOT EDIT VERSION NUMBERS HERE - Change OPIK_VERSION in .env.azure instead
# This is a TEMPLATE file processed by deploy-opik-helm-azure.sh

registry: &registry $ACR_LOGIN_SERVER

# OAuth2 Proxy Configuration for Azure Entra ID Authentication
oauth2-proxy:
  enabled: true
  
  config:
    clientID: "$APP_ID"
    clientSecret: "$CLIENT_SECRET"
    cookieSecret: "$OAUTH2_COOKIE_SECRET"
    
  extraArgs:
    provider: "azure"
    azure-tenant: "$TENANT_ID"
    oidc-issuer-url: "https://login.microsoftonline.com/$TENANT_ID/v2.0"
    email-domain: "*"
    http-address: "0.0.0.0:4180"
    redirect-url: "https://$PUBLIC_IP_ADDRESS/oauth2/callback"
    skip-provider-button: "true"
    # Minimize header size to fix 431 errors for users with many groups
    pass-access-token: "false"
    pass-user-headers: "false"
    pass-authorization-header: "false"
    set-xauthrequest: "true"
    cookie-expire: "24h"
    cookie-refresh: "1h"
    cookie-secure: "true"
    cookie-samesite: "lax"
    # Route to our nginx proxy which handles the routing to backend services
    upstream: "http://opik-nginx-proxy.$NAMESPACE.svc.cluster.local:80"
    # Minimal scope - only what's needed for group checking
    scope: "openid email profile groups"
    # Set user ID claim to use userPrincipalName from Azure AD
    user-id-claim: "preferred_username"
    
    # Group-based access control - restrict access to members of the Opik Users group
    # For Azure AD, use allowed-group with the group object ID
    allowed-group: "$OPIK_ACCESS_GROUP_ID"
    # Alternative: use allowed-groups (comma-separated) if multiple groups needed
    # allowed-groups: "$OPIK_ACCESS_GROUP_ID"
  
  service:
    type: ClusterIP
    portNumber: 4180
    
  ingress:
    enabled: false

component:
  backend:
    image:
      repository: opik-backend
      tag: $OPIK_VERSION
    env:
      OPIK_VERSION: "$OPIK_VERSION"
      TOGGLE_TRACE_THREAD_PYTHON_EVALUATOR_ENABLED: "true"
      OPIK_USAGE_REPORT_ENABLED: "true"
    ingress:
      enabled: false
      
  python-backend:
    image:
      repository: opik-python-backend
      tag: $OPIK_VERSION
    env:
      OPIK_VERSION: "$OPIK_VERSION"
      PYTHON_CODE_EXECUTOR_IMAGE_REGISTRY: *registry
      PYTHON_CODE_EXECUTOR_IMAGE_NAME: "opik-sandbox-executor-python"
      PYTHON_CODE_EXECUTOR_IMAGE_TAG: "$OPIK_VERSION"
      PYTHON_CODE_EXECUTOR_STRATEGY: "process"
      PYTHON_CODE_EXECUTOR_PARALLEL_NUM: "4"
      OPIK_REVERSE_PROXY_URL: ""
    ingress:
      enabled: false
      
  frontend:
    image:
      repository: opik-frontend
      tag: $OPIK_VERSION
    ingress:
      enabled: false

# Disable demo data generation for production
demoDataJob:
  enabled: false

# Configure resources for Azure
clickhouse:
  enabled: true
  persistence:
    enabled: true
    size: 20Gi
    
mysql:
  enabled: true
  primary:
    persistence:
      enabled: true
      size: 10Gi

redis:
  enabled: true
  master:
    persistence:
      enabled: true
      size: 5Gi
