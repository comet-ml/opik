# Fluent Bit Configuration for NGINX Access Log Shipping to OTel Collector
# Simplified configuration using built-in JSON parser

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# nginx logs to stdout - read from container's stdout stream
# This reads from the same stream that docker logs shows
[INPUT]
    Name              tail
    Path              /proc/1/fd/1
    Tag               nginx.access
    Refresh_Interval  1
    Skip_Empty_Lines  On
    Read_from_Head    On
    # Note: Position DB not needed for stream-based logging (/proc/1/fd/1)
    # Stream resets on container restart, Docker handles lifecycle

# Collect Fluent Bit's own metrics
[INPUT]
    Name            fluentbit_metrics
    Tag             fluent_bit.metrics
    Scrape_interval 30

[OUTPUT]
    Name        opentelemetry
    Match       nginx.access
    Host        ${OTEL_COLLECTOR_HOST}
    Port        ${OTEL_COLLECTOR_PORT}
    Logs_uri    /v1/logs
    Tls         Off
    Log_response_payload False

# Send Fluent Bit metrics to OTel Collector
[OUTPUT]
    Name        opentelemetry
    Match       fluent_bit.metrics
    Host        ${OTEL_COLLECTOR_HOST}
    Port        ${OTEL_COLLECTOR_PORT}
    Metrics_uri /v1/metrics
    Tls         Off
    Log_response_payload False
