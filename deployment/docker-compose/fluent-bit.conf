# Fluent Bit Configuration for NGINX Access Log Shipping to OTel Collector
# Simplified configuration using built-in JSON parser

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Parsers_File  /fluent-bit/etc/parsers.conf

# Receive nginx logs via UDP syslog (both access and error logs)
# The syslog input uses syslog-rfc3164 parser to parse the syslog header
# We'll use a filter to parse the Nginx log format from the message field
[INPUT]
    Name              syslog
    Mode              udp
    Listen            0.0.0.0
    Port              5140
    Parser            syslog-rfc3164
    Tag               nginx.syslog
# Collect Fluent Bit's own metrics
# [INPUT]
#     Name            fluentbit_metrics
#     Tag             fluent_bit.metrics
#     Scrape_interval 30

# Parse Nginx log format from the message field
# The syslog input parses the header, leaving the message field with: "nginx_access: 172.19.0.1 - - [...]"
# [FILTER]
#     Name                parser
#     Match               nginx.syslog
#     Key_Name            message
#     Parser              syslog-nginx
#     Reserve_Data        On
#     Preserve_Key        Off

# # Debug: Output nginx logs to stdout (comment out in production)
[OUTPUT]
    Name        stdout
    Match       nginx.syslog
    Format      json_string

# Send nginx logs (access and error) to OTel Collector
# Note: Fluent Bit's opentelemetry plugin only supports HTTP (not gRPC)
# Use port 4318 for HTTP OTLP endpoint
# [OUTPUT]
#     Name        opentelemetry
#     Match       nginx.syslog
#     Host        ${OTEL_COLLECTOR_HOST}
#     Port        ${OTEL_COLLECTOR_PORT}
#     Logs_uri    /v1/logs
#     Tls         Off
#     Log_response_payload False

# Send Fluent Bit metrics to OTel Collector
# [OUTPUT]
#     Name        opentelemetry
#     Match       fluent_bit.metrics
#     Host        ${OTEL_COLLECTOR_HOST}
#     Port        ${OTEL_COLLECTOR_PORT}
#     Metrics_uri /v1/metrics
#     Tls         Off
#     Log_response_payload False
