# Fluent Bit Configuration for NGINX Access Log Shipping to OTel Collector
# Simplified configuration using built-in JSON parser

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

[INPUT]
    Name              tail
    Path              /var/log/nginx/access.log
    Path_Key          file
    Tag               nginx.access
    Refresh_Interval  1
    Skip_Empty_Lines  On
    Read_from_Head    On
    
    # Database for position tracking
    DB                /var/log/fluent-bit/pos.db

# Collect Fluent Bit's own metrics
[INPUT]
    Name            fluentbit_metrics
    Tag             fluent_bit.metrics
    Scrape_interval 30

[OUTPUT]
    Name        opentelemetry
    Match       nginx.access
    Host        ${OTEL_COLLECTOR_HOST:-otel-collector}
    Port        ${OTEL_COLLECTOR_PORT:-4317}
    Logs_uri    /v1/logs
    Tls         Off
    Log_response_payload True

# Send Fluent Bit metrics to OTel Collector
[OUTPUT]
    Name        opentelemetry
    Match       fluent_bit.metrics
    Host        ${OTEL_COLLECTOR_HOST:-otel-collector}
    Port        ${OTEL_COLLECTOR_PORT:-4317}
    Metrics_uri /v1/metrics
    Tls         Off
    Log_response_payload True
