# Fluent Bit Parsers Configuration
# Define syslog parser for RFC3164 format (used by syslog input to parse headers)
# Format: <priority>timestamp hostname ident[pid]: message (with tag) or ident[pid] message (without tag)
# Example with tag: <190>Nov 26 16:46:22 frontend nginx_access: 172.19.0.1 - - [26/Nov/2025:16:46:22 +0000] "GET /a HTTP/1.1" 200 514 "-" "curl/8.14.1"
# Example without tag: <190>Nov 26 16:46:22 frontend nginx: 172.19.0.1 - - [26/Nov/2025:16:46:22 +0000] "GET /a HTTP/1.1" 200 514 "-" "curl/8.14.1"
[PARSER]
    Name        syslog-rfc3164
    Format      regex
    # More lenient regex that captures everything after ident as message
    # The time pattern matches: "Nov 26 16:54:33" (month day time)
    # Handle both cases: with colon (tag) and without colon (no tag)
    Regex       ^\<(?<pri>[0-9]+)\>(?<time>[A-Za-z]{3} +[0-9]{1,2} +[0-9]{2}:[0-9]{2}:[0-9]{2}) (?<host>[^ ]+) (?<ident>[^: ]+)(?::\s+)?(?<message>.*)$
    Time_Key    time
    Time_Format %b %d %H:%M:%S
    Time_Keep   On

# Define parser for Nginx access logs sent via syslog
# The syslog input parses the header using syslog-rfc3164, leaving the message field
# Nginx log format: $remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for"
# Without tag, the message field contains: "172.19.0.1 - - [26/Nov/2025:16:37:03 +0000] "GET /a HTTP/1.1" 200 514 "-" "curl/8.14.1""
# With tag, it would be: "nginx_access: 172.19.0.1 - - [...]" but may cause truncation
[PARSER]
    Name        syslog-nginx
    Format      regex
    # Extract Nginx log fields from the message
    # Handle optional tag prefix (e.g., "nginx_access: ") if tag is used
    Regex       ^(?:[^:]+:\s+)?(?<remote_addr>[^ ]+) - (?<remote_user>[^ ]+) \[(?<time_local>[^\]]+)\] "(?<request>[^"]*)" (?<status>\d+) (?<body_bytes_sent>\d+) "(?<http_referer>[^"]*)" "(?<http_user_agent>[^"]*)" "(?<http_x_forwarded_for>[^"]*)"$
    Time_Key    time_local
    Time_Format %d/%b/%Y:%H:%M:%S %z
    Time_Keep   On

