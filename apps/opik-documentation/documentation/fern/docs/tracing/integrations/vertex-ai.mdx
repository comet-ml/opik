# �� Opik Setup: Vertex AI Integration via Custom IAM Role and Service Account

To enable Opik to communicate with Vertex AI, you'll need to create a custom IAM role, bind it to a service account, and then input the service account's credentials into the Opik configuration panel.

---

## ⚙️ Option A: Setup via `gcloud` CLI

### 1. **Create a Custom IAM Role**
```bash
gcloud iam roles create opik \
  --project=<my-project> \
  --title="Opik" \
  --description="Custom IAM role for Opik" \
  --permissions=aiplatform.endpoints.predict,resourcemanager.projects.get \
  --stage=ALPHA
```

### 2. **Create a Service Account**
```bash
gcloud iam service-accounts create opik-sa \
  --description="Service account for Opik role" \
  --display-name="Opik Service Account"
```

### 3. **Assign the Role to the Service Account**
```bash
gcloud projects add-iam-policy-binding <my-project> \
  --member="serviceAccount:opik-sa@<my-project>.iam.gserviceaccount.com" \
  --role="projects/<my-project>/roles/opik"
```

### 4. **Generate the Service Account Key File**
```bash
gcloud iam service-accounts keys create opik-key.json \
  --iam-account=opik-sa@<my-project>.iam.gserviceaccount.com
```

> �� The file `opik-key.json` contains your credentials. **Open it in a text editor and copy the entire contents.**

---

## ��️ Option B: Setup via Google Cloud Console (UI)

### Step 1: Create the Custom Role
1. Go to [IAM → Roles](https://console.cloud.google.com/iam-admin/roles)
2. Click **Create Role**
3. Fill in the form:
- **Title**: `Opik`
- **ID**: `opik`
- **Description**: `Custom IAM role for Opik`
- **Stage**: `Alpha`
4. Click **Add Permissions**, then search for and add:
- `aiplatform.endpoints.predict`
- `resourcemanager.projects.get`
5. Click **Create**

### Step 2: Create the Service Account
1. Go to [IAM → Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts)
2. Click **Create Service Account**
3. Fill in:
- **Service account name**: `Opik Service Account`
- **ID**: `opik-sa`
- **Description**: `Service account for Opik role`
4. Click **Done**

### Step 3: Assign the Role to the Service Account
1. Go to [IAM](https://console.cloud.google.com/iam-admin/iam)
2. Find the service account `opik-sa@<my-project>.iam.gserviceaccount.com`
3. Click the **edit icon**
4. Click **Add Another Role** → Select your custom role: **Opik**
5. Click **Save**

### Step 4: Create and Download the Key
1. Go to [Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts)
2. Click on the `opik-sa` account
3. Open the **Keys** tab
4. Click **Add Key → Create new key**
5. Choose **JSON**, click **Create**, and download the file

> �� **Open the downloaded JSON file**, and **copy its entire content** to be used in the next step.

---

## �� Final Step: Connect Opik to Vertex AI

1. In Opik, go to **Configuration → AI Providers**
2. Click **“Add Configuration”**
3. Set:
- **Provider**: `Vertex AI`
- **Location**: Your model region (e.g., `us-central1`)
- **Vertex AI API Key**: **Paste the full contents of the `opik-key.json` file here**
4. Click **Add configuration**

![Opik Vertex AI API Key Input](attachment:file-PkZxbMM6EmrxkhritfZS4C)

---

## ✅ You're Done!
Opik can now send prompts to Vertex AI using the configured service account, with appropriate access controls via your custom role.

Let me know if you'd like to add a section for automated Terraform provisioning.