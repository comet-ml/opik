---
description: How to send Mastra telemetry data to Opik using OpenTelemetry
---

# Mastra Integration via OpenTelemetry

Mastra is an AI workflow framework designed to simplify the creation and orchestration of complex AI pipelines. It provides a declarative approach to building AI workflows with built-in support for parallel execution, error handling, and workflow optimization.

Mastra's primary advantage is its workflow-first design that makes it easy to build, test, and deploy production AI pipelines with minimal boilerplate code.

<Frame>
  <img src="/img/tracing/mastra_integration.png" alt="Mastra tracing" />
</Frame>

## Getting started

To use the Mastra integration with Opik, you will need to have Mastra and the required OpenTelemetry packages installed.

### Installation

```bash
npm install mastra @opentelemetry/sdk-node @opentelemetry/auto-instrumentations-node @opentelemetry/exporter-trace-otlp-http
```

## Environment configuration

Set up your environment variables based on your Opik deployment:

<Tabs>
    <Tab value="Opik Cloud" title="Opik Cloud">
        ```bash wordWrap
        export OTEL_EXPORTER_OTLP_ENDPOINT=https://www.comet.com/opik/api/v1/private/otel
        export OTEL_EXPORTER_OTLP_HEADERS='Authorization=<your-api-key>,Comet-Workspace=default'
        ```
    </Tab>
    <Tab value="Enterprise deployment" title="Enterprise deployment">
        ```bash wordWrap
        export OTEL_EXPORTER_OTLP_ENDPOINT=https://<comet-deployment-url>/opik/api/v1/private/otel
        export OTEL_EXPORTER_OTLP_HEADERS='Authorization=<your-api-key>,Comet-Workspace=default'
        ```
    </Tab>
    <Tab value="Self-hosted instance" title="Self-hosted instance">
        ```bash
        export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:5173/api/v1/private/otel
        export OTEL_EXPORTER_OTLP_HEADERS='projectName=<your-project-name>'
        ```
    </Tab>
</Tabs>

## Using Opik with Mastra

Mastra supports the OpenTelemetry Protocol (OTLP) for tracing and monitoring your application. When telemetry is enabled, Mastra automatically traces all core primitives including agent operations, LLM interactions, tool executions, integration calls, workflow runs, and database operations.

### Basic Configuration

Here's a simple example of enabling telemetry with Mastra:

```typescript
import { Mastra } from "mastra";

export const mastra = new Mastra({
  // ... other config
  telemetry: {
    serviceName: "my-mastra-app",
    enabled: true,
    sampling: {
      type: "always_on",
    },
    export: {
      type: "otlp",
      endpoint: process.env.OTEL_EXPORTER_OTLP_ENDPOINT,
      headers: process.env.OTEL_EXPORTER_OTLP_HEADERS
        ? Object.fromEntries(process.env.OTEL_EXPORTER_OTLP_HEADERS.split(",").map((h) => h.split("=")))
        : undefined,
    },
  },
});
```

### Configuration Options

The telemetry config accepts these properties:

```typescript
type OtelConfig = {
  // Name to identify your service in traces (optional)
  serviceName?: string;

  // Enable/disable telemetry (defaults to true)
  enabled?: boolean;

  // Control how many traces are sampled
  sampling?: {
    type: "ratio" | "always_on" | "always_off" | "parent_based";
    probability?: number; // For ratio sampling
    root?: {
      probability: number; // For parent_based sampling
    };
  };

  // Where to send telemetry data
  export?: {
    type: "otlp" | "console";
    endpoint?: string;
    headers?: Record<string, string>;
  };
};
```

## Results viewing

Once configured, all your Mastra operations will automatically create traces in Opik. You can view these traces in the Opik dashboard to monitor:

- Agent operations and their performance
- LLM interactions with timing and token usage
- Tool executions and their results
- Workflow runs and their step-by-step execution
- Database operations and their performance

## Further improvements

If you have any suggestions for improving this integration, please [open an issue on GitHub](https://github.com/comet-ml/opik/issues/new/choose).
