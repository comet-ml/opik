name: Trigger Test Environment Deployment
run-name: ${{ github.event.label.name == 'deploy_pr_public' && format('Trigger Public Test Environment Deployment for PR {0} by {1}', github.event.number, github.actor) || github.event.label.name == 'deploy_pr_internal' && format('Trigger Test Environment Deployment for PR {0} by {1}', github.event.number, github.actor) || 'Test Environment Not Triggered' }}

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:

  other-labels:
    if: github.event.label.name != 'deploy_pr_internal' && github.event.label.name != 'deploy_pr_public'
    runs-on: ubuntu-latest
    steps:
      - name: Skip
        run: |
          echo "Skipping deployment of test environment for this PR"

  determine-environment:
    if: github.event.label.name == 'deploy_pr_internal' || github.event.label.name == 'deploy_pr_public'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      base_domain: ${{ steps.env.outputs.base_domain }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event.label.name }}" == "deploy_pr_internal" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "base_domain=dev.comet.com" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.label.name }}" == "deploy_pr_public" ]]; then
            echo "environment=opik-public" >> $GITHUB_OUTPUT
            echo "base_domain=opikpub.comet.com" >> $GITHUB_OUTPUT
          fi

  notify-started:
    if: github.event.label.name == 'deploy_pr_internal' || github.event.label.name == 'deploy_pr_public'
    needs:
      - determine-environment
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR - Deployment Started
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: Number('${{ github.event.number }}'),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîÑ **Test environment deployment started**
              Building images for PR #${{ github.event.number }}...
              
              You can monitor the build progress [here](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`
            });

  build-apps:
    if: github.event.label.name == 'deploy_pr_internal' || github.event.label.name == 'deploy_pr_public'
    needs:
      - determine-environment
      - notify-started
    uses: ./.github/workflows/build_apps.yml
    secrets: inherit
    with:
      version: ""
      is_release: false
      build_guardrails: false
      ref: ${{ github.event.pull_request.head.ref }}

  notify-build-finished:
    if: github.event.label.name == 'deploy_pr_internal' || github.event.label.name == 'deploy_pr_public'
    needs:
      - determine-environment
      - build-apps
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR - Build Finished
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: Number('${{ github.event.number }}'),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Build completed successfully**
              
              - **Version:** ${{ needs.build-apps.outputs.version }}
              
              Starting deployment...`
            });

  trigger_deployment:
    if: github.event.label.name == 'deploy_pr_internal' || github.event.label.name == 'deploy_pr_public'
    needs:
      - determine-environment
      - build-apps
      - notify-build-finished
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deployment via repository dispatch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPLOYMENT_TRIGGER_TOKEN }}
          script: |
            const response = await github.rest.repos.createDispatchEvent({
              owner: 'comet-ml',
              repo: 'comet-deployment',
              event_type: 'deploy-opik-test-env',
              client_payload: {
                pr_number: '${{ github.event.number }}',
                version_name: '${{ needs.build-apps.outputs.version }}',
                environment: '${{ needs.determine-environment.outputs.environment }}'
              }
            });
            
            console.log('Repository dispatch sent:', response.status);
            
            // Comment on PR with deployment info
            await github.rest.issues.createComment({
              issue_number: Number('${{ github.event.number }}'),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Test environment deployment triggered!**

              ### Access Information
              - **URL:** https://pr-${{ github.event.number }}.dev.comet.com
              - **Namespace:** pr-${{ github.event.number }}
              - **Version:** ${{ needs.build-apps.outputs.version }}
                     
              You can monitor the deployment progress [here](https://github.com/comet-ml/comet-deployment/actions/workflows/deploy_opik_adhoc_env.yaml).`
            });

      - name: Handle deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: Number('${{ github.event.number }}'),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Failed to trigger test environment deployment**`
            });
