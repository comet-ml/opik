name: Trigger Test Environment Deployment
run-name: ${{ github.event.label.name == 'test-environment' && format('Trigger Test Environment Deployment for PR {0} by {1}', github.event.number, github.actor) || 'Test Environment Not Triggered' }}

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:

  other-labels:
    if: github.event.label.name != 'test-environment'
    runs-on: ubuntu-latest
    steps:
      - name: Skip
        run: |
          echo "Skipping deployment of test environment for this PR"

  notify-started:
    if: github.event.label.name == 'test-environment'
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR - Deployment Started
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: Number('${{ github.event.number }}'),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîÑ **Test environment deployment started**
              
              Building images for PR #${{ github.event.number }}...
              
              You can monitor the build progress [here](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`
            });

  build-apps:
    if: github.event.label.name == 'test-environment'
    needs:
      - notify-started
    uses: ./.github/workflows/build_apps.yml
    secrets: inherit
    with:
      version: ""
      is_release: false
      build_guardrails: false
      ref: ${{ github.event.pull_request.head.ref }}

  trigger_deployment:
    if: github.event.label.name == 'test-environment'
    needs:
      - build-apps
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deployment via repository dispatch
        uses: actions/github-script@v7
        env:
          VERSION_NAME: ${{ needs.build-apps.outputs.version }}
        with:
          github-token: ${{ secrets.DEPLOYMENT_TRIGGER_TOKEN }}
          script: |
            const response = await github.rest.repos.createDispatchEvent({
              owner: 'comet-ml',
              repo: 'comet-deployment',
              event_type: 'deploy-opik-test-env',
              client_payload: {
                pr_number: '${{ github.event.number }}',
                version_name: process.env.VERSION_NAME
              }
            });
            
            console.log('‚úÖ Repository dispatch sent successfully:', response.status);
            console.log('üìä Monitor deployment progress: https://github.com/comet-ml/comet-deployment/actions/workflows/deploy_opik_adhoc_env.yaml');
            console.log('üîó Deployment will verify the version and post a comment on this PR when complete');

      - name: Handle trigger failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: Number('${{ github.event.number }}'),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Failed to trigger test environment deployment**
              
              Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.`
            });
