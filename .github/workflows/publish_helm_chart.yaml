name: Publish Opik Helm Chart
run-name: "Publish Opik Helm Chart ${{ github.ref_name }} by @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        description: Version
        default: ""
  workflow_call:
    inputs:
      version:
        type: string
        required: true
        description: Version
        default: ""


jobs:

  publish-helm-chart:

    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:

        - name: Checkout
          uses: actions/checkout@v4.1.1
          with:
            ref: ${{inputs.version}}
            fetch-tags: true
            path: 'src'
            fetch-depth: 0

        - name: Checkout GH Pages branch
          uses: actions/checkout@v4.1.1
          with:
            path: 'dest'
            ref: 'gh-pages'
            fetch-depth: 0

        - name: Install Helm
          uses: azure/setup-helm@v4.2.0
          with:
            version: v3.13.0

        - name: Run lint on Helm chart
          shell: bash
          working-directory: src
          run: |
            set -e
            cd deployment/helm_chart/opik
            helm repo add mysql https://comet-ml.github.io/comet-mysql-helm/
            helm repo add clickhouse-operator https://docs.altinity.com/clickhouse-operator
            helm dependency build
            helm lint --values values.yaml .
            cd -

        - name: Package helm chart
          shell: bash
          working-directory: src
          run: |
            cd deployment/helm_chart
            helm package --version ${{inputs.version}} --app-version ${{inputs.version}} opik/ -u -d ../../../dest
            cd -
            echo "Copy updated README"
            cp deployment/helm_chart/opik/README.md ../dest/.

        - name: Fix Charts timestamps
          shell: bash
          working-directory: dest
          env:
            INDEX_FILE: index.yaml
          run: |
            # this step can be removed after fix applied
            # get timestamps for files
            git ls-files -z | while read -d $'\0' file; do
              TIME=$(git log -1 --format="%cI" -- "$file")
              touch -d "$TIME" "$file"
            done

            # 1. Get a list of all chart filenames mentioned in the index
            # We use yq to extract the 'urls' which usually contain the filename
            CHARTS=$(yq eval '.entries[] | .[] | .urls[0]' "${INDEX_FILE}")

            for CHART_URL in $CHARTS; do
                # Extract filename from URL (e.g., opik-1.9.76.tgz)
                FILENAME=$(basename "$CHART_URL")
                
                if [ -f "$FILENAME" ]; then
                    # Get modification time in ISO 8601 format (e.g., 2024-11-12T12:56:00Z)
                    # Using 'date' to ensure UTC format which Helm prefers
                    MTIME=$(date -u -r "$FILENAME" +"%Y-%m-%dT%H:%M:%SZ")
                    
                    echo "Updating $FILENAME with date $MTIME"

                    # Update the 'created' field for this specific version in index.yaml
                    # We match by the first URL in the list
                    yq eval "(.entries[] | select(.[] | .urls[0] == \"$CHART_URL\") | .[].created) = \"$MTIME\"" -i "${INDEX_FILE}"
                else
                    echo "Warning: File $FILENAME not found on disk, skipping..."
                fi
            done

            echo "Done! ${INDEX_FILE} dates synchronized with filesystem."

        - name: Push New Files
          shell: bash
          working-directory: dest
          run: |
              helm repo index . --url https://raw.githubusercontent.com/comet-ml/opik/gh-pages/ --merge index.yaml
              git config user.name "Helm Updater"
              git config user.email "actions@users.noreply.github.com"
              git add $(git ls-files -o --exclude-standard)
              git add index.yaml README.md
              git commit -m "Release Opik helm chart ${{inputs.version}}"
              git push   

        - name: Summary
          run: |
            echo "Helm chart is published, version is : ${{inputs.version}}" >> $GITHUB_STEP_SUMMARY


