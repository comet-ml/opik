# Runner for the suite of library integration tests
#
#          echo "result=${{ secrets.OPENAI_API_KEY != '' }}" >> $GITHUB_OUTPUT
name: SDK Library Integration Tests Runner
run-name: "SDK Library Integration Tests Runner ${{ github.ref_name }} by @${{ github.actor }}"
permissions:
  contents: read
on:
  workflow_dispatch:
    inputs:
      libs:
        description: "Choose specific library to test against or all"
        required: true
        type: choice
        options:
          - all
          - openai
          - langchain
          - langchain_legacy
          - llama_index
          - anthropic
          - aisuite
          - haystack
          - guardrails
          - dspy
          - crewai_v0
          - crewai_v1
          - genai
          - adk
          - adk_legacy_1_3_0
          - metrics
          - bedrock
          - litellm
          - harbor
      run_expensive_tests:
        description: "Run expensive tests (e.g., video generation). Enabled by default on weekly scheduled runs."
        required: false
        type: boolean
        default: false
  schedule:
    # Daily run at midnight UTC Monday-Saturday (without expensive tests)
    - cron: "0 0 * * 1-6"
    # Weekly run on Sunday at midnight UTC (with expensive tests)
    - cron: "0 0 * * 0"
  pull_request:
    paths:
    - 'sdks/python/**'
  push:
    branches: 
      - 'main'
    paths:
      - 'sdks/python/**'

env:
  SLACK_WEBHOOK_URL: ${{ secrets.ACTION_MONITORING_SLACK }}
  LIBS: ${{ github.event.inputs.libs != '' && github.event.inputs.libs  || 'all' }}
  OPIK_SENTRY_ENABLE: False

jobs:
  has_needed_secrets:
    name: Check Secrets
    runs-on: ubuntu-latest
    outputs:
      has_secrets: ${{ steps.init.outputs.has_secrets }}
    steps:
      - name: Print has secrets into output
        id: init
        run: |
          echo "has_secrets=${{ secrets.OPENAI_API_KEY != '' }}" >> $GITHUB_OUTPUT

  missed_api_key_warning:
    name: Missed OpenAI API Key Warning
    needs: [has_needed_secrets]
    runs-on: ubuntu-latest
    if: ${{ needs.has_needed_secrets.outputs.has_secrets == 'false' }}
    steps:
      - name: Print disabled message
        run: |
          echo "::warning::SDK Library Integration Tests are disabled because OPENAI_API_KEY is not set"

  init_environment:
    name: Build
    needs: [has_needed_secrets]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ needs.has_needed_secrets.outputs.has_secrets == 'true' }}
    outputs:
      LIBS: ${{ steps.init.outputs.LIBS }}

    steps:
      - name: Make LIBS variable global (workaround for cron)
        id: init
        run: |
          echo "LIBS=${{ env.LIBS }}" >> $GITHUB_OUTPUT

  openai_tests:
    needs: [init_environment]
    if: contains(fromJSON('["openai", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-openai-tests.yml
    with:
      # Run expensive tests on weekly schedule (Sunday) or when manually requested
      run_expensive_tests: ${{ (github.event_name == 'schedule' && github.event.schedule == '0 0 * * 0') || github.event.inputs.run_expensive_tests == 'true' }}
    secrets: inherit
  
  langchain_tests:
    needs: [init_environment]
    if: contains(fromJSON('["langchain", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-langchain-tests.yml
    secrets: inherit
  
  langchain_legacy_tests:
    needs: [init_environment]
    if: contains(fromJSON('["langchain_legacy", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-langchain-legacy-tests.yml
    secrets: inherit
  
  llama_index_tests:
    needs: [init_environment]
    if: contains(fromJSON('["llama_index", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-llama-index-tests.yml
    secrets: inherit

  anthropic_tests:
    needs: [init_environment]
    if: contains(fromJSON('["anthropic", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-anthropic-tests.yml
    secrets: inherit

  aisuite_tests:
    needs: [init_environment]
    if: contains(fromJSON('["aisuite", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-aisuite-tests.yml
    secrets: inherit

  haystack_tests:
    needs: [init_environment]
    if: contains(fromJSON('["haystack", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-haystack-tests.yml
    secrets: inherit

  guardrails_tests:
    needs: [init_environment]
    if: contains(fromJSON('["guardrails", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-guardrails-tests.yml
    secrets: inherit

  dspy_tests:
    needs: [init_environment]
    if: contains(fromJSON('["dspy", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-dspy-tests.yml
    secrets: inherit

  crewai_v0_tests:
    needs: [init_environment]
    if: contains(fromJSON('["crewai_v0", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-crewai-v0-tests.yml
    secrets: inherit

  crewai_v1_tests:
    needs: [init_environment]
    if: contains(fromJSON('["crewai_v1", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-crewai-v1-tests.yml
    secrets: inherit
  
  genai_tests:
    needs: [init_environment]
    if: contains(fromJSON('["genai", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-genai-tests.yml
    with:
      # Run expensive tests on weekly schedule (Sunday) or when manually requested
      run_expensive_tests: ${{ (github.event_name == 'schedule' && github.event.schedule == '0 0 * * 0') || github.event.inputs.run_expensive_tests == 'true' }}
    secrets: inherit

  adk_tests:
    needs: [init_environment]
    if: contains(fromJSON('["adk", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-adk-tests.yml
    secrets: inherit

  adk_legacy_1_3_0_tests:
    needs: [init_environment]
    if: contains(fromJSON('["adk_legacy_1_3_0", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-adk-legacy-1-3-0-tests.yml
    secrets: inherit

  evaluation_metrics_tests:
    needs: [init_environment]
    if: contains(fromJSON('["metrics", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-metrics-with-llm-judge-tests.yml
    secrets: inherit

  bedrock_tests:
    needs: [init_environment]
    if: contains(fromJSON('["bedrock", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-bedrock-tests.yml
    secrets: inherit

  litellm_tests:
    needs: [init_environment]
    if: contains(fromJSON('["litellm", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-litellm-tests.yml
    secrets: inherit

  harbor_tests:
    needs: [init_environment]
    if: contains(fromJSON('["harbor", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-harbor-tests.yml
    secrets: inherit

  # ========================================
  # Slack Notification (manual and scheduled runs only)
  # ========================================
  notify-slack:
    name: "Slack Notification"
    runs-on: ubuntu-latest
    needs:
      - openai_tests
      - langchain_tests
      - langchain_legacy_tests
      - llama_index_tests
      - anthropic_tests
      - aisuite_tests
      - haystack_tests
      - guardrails_tests
      - dspy_tests
      - crewai_v0_tests
      - crewai_v1_tests
      - genai_tests
      - adk_tests
      - adk_legacy_1_3_0_tests
      - evaluation_metrics_tests
      - bedrock_tests
      - litellm_tests
      - harbor_tests
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
      - name: "üîç Check Slack configuration"
        id: check-slack
        run: |
          if [ -z "${{ secrets.ACTION_MONITORING_SLACK }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::ACTION_MONITORING_SLACK not configured - Slack notification will be skipped"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: "üì¢ Send Slack notification"
        if: steps.check-slack.outputs.configured == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.ACTION_MONITORING_SLACK }}
        run: |
          # Gather information
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref_name }}"
          
          # Determine trigger type for display
          if [ "${{ github.event_name }}" == "schedule" ]; then
            TRIGGER_TYPE=$([[ "${{ github.event.schedule }}" == "0 0 * * 0" ]] && echo "Weekly Schedule" || echo "Daily Schedule")
          else
            TRIGGER_TYPE="Manual Dispatch"
          fi
          
          # Collect failed test suites
          FAILED_SUITES=""
          [ "${{ needs.openai_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|OpenAI>\n"
          [ "${{ needs.langchain_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|LangChain>\n"
          [ "${{ needs.langchain_legacy_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|LangChain Legacy>\n"
          [ "${{ needs.llama_index_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|LlamaIndex>\n"
          [ "${{ needs.anthropic_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|Anthropic>\n"
          [ "${{ needs.aisuite_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|AISuite>\n"
          [ "${{ needs.haystack_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|Haystack>\n"
          [ "${{ needs.guardrails_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|Guardrails>\n"
          [ "${{ needs.dspy_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|DSPy>\n"
          [ "${{ needs.crewai_v0_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|CrewAI v0>\n"
          [ "${{ needs.crewai_v1_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|CrewAI v1>\n"
          [ "${{ needs.genai_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|GenAI>\n"
          [ "${{ needs.adk_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|ADK>\n"
          [ "${{ needs.adk_legacy_1_3_0_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|ADK Legacy 1.3.0>\n"
          [ "${{ needs.evaluation_metrics_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|Evaluation Metrics>\n"
          [ "${{ needs.bedrock_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|Bedrock>\n"
          [ "${{ needs.litellm_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|LiteLLM>\n"
          [ "${{ needs.harbor_tests.result }}" == "failure" ] && FAILED_SUITES="${FAILED_SUITES}‚Ä¢ <${WORKFLOW_URL}|Harbor>\n"
          
          FAILURE_COUNT=$(echo -e "$FAILED_SUITES" | grep -c "‚Ä¢" || echo "0")
          
          # Determine status
          if [ "$FAILURE_COUNT" -gt 0 ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="Failed"
            COLOR="danger"
            FAILED_SECTION=$(cat << INNER_EOF
          ,
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Failed Test Suites:*\n$(echo -e "$FAILED_SUITES")"
                    }
                  }
          INNER_EOF
          )
          else
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="Passed"
            COLOR="good"
            FAILED_SECTION=""
          fi
          
          # Build payload
          cat << EOF > payload.json
          {
            "attachments": [
              {
                "color": "$COLOR",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$STATUS_EMOJI Python SDK Integration Tests $STATUS_TEXT",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Trigger:*\n$TRIGGER_TYPE"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch:*\n\`$BRANCH\`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Failed:*\n$FAILURE_COUNT suite(s)"
                      }
                    ]
                  }$FAILED_SECTION,
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "üîç View Workflow",
                          "emoji": true
                        },
                        "url": "$WORKFLOW_URL"
                      }
                    ]
                  }
                ]
              }
            ]
          }
          EOF
          
          # Send notification
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H 'Content-type: application/json' \
            --data @payload.json \
            "$SLACK_WEBHOOK_URL")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Slack notification sent successfully"
          else
            echo "‚ö†Ô∏è Slack notification failed with HTTP code: $HTTP_CODE"
            cat payload.json
            exit 1
          fi

      - name: "‚ÑπÔ∏è Slack not configured"
        if: steps.check-slack.outputs.configured != 'true'
        run: |
          echo "## üì¢ Slack Notification Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Slack notifications are not configured. To enable them:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add the webhook URL as a repository secret named \`ACTION_MONITORING_SLACK\`" >> $GITHUB_STEP_SUMMARY
