# Runner for the suite of library integration tests
#
#          echo "result=${{ secrets.OPENAI_API_KEY != '' }}" >> $GITHUB_OUTPUT
name: SDK Library Integration Tests Runner
run-name: "SDK Library Integration Tests Runner ${{ github.ref_name }} by @${{ github.actor }}"
permissions:
  contents: read
on:
  workflow_dispatch:
    inputs:
      libs:
        description: "Choose specific library to test against or all"
        required: true
        type: choice
        options:
          - all
          - openai
          - langchain
          - langchain_legacy
          - llama_index
          - anthropic
          - aisuite
          - haystack
          - guardrails
          - dspy
          - crewai_v0
          - crewai_v1
          - genai
          - adk
          - adk_legacy_1_3_0
          - metrics
          - bedrock
          - litellm
          - harbor
      run_expensive_tests:
        description: "Run expensive tests (e.g., video generation). Enabled by default on weekly scheduled runs."
        required: false
        type: boolean
        default: false
  schedule:
    # Daily run at midnight UTC Monday-Saturday (without expensive tests)
    - cron: "0 0 * * 1-6"
    # Weekly run on Sunday at midnight UTC (with expensive tests)
    - cron: "0 0 * * 0"
  pull_request:
    paths:
    - 'sdks/python/**'
  push:
    branches: 
      - 'main'
    paths:
      - 'sdks/python/**'

env:
  SLACK_WEBHOOK_URL: ${{ secrets.ACTION_MONITORING_SLACK }}
  LIBS: ${{ github.event.inputs.libs != '' && github.event.inputs.libs  || 'all' }}
  OPIK_SENTRY_ENABLE: False

jobs:
  has_needed_secrets:
    name: Check Secrets
    runs-on: ubuntu-latest
    outputs:
      has_secrets: ${{ steps.init.outputs.has_secrets }}
    steps:
      - name: Print has secrets into output
        id: init
        run: |
          echo "has_secrets=${{ secrets.OPENAI_API_KEY != '' }}" >> $GITHUB_OUTPUT

  missed_api_key_warning:
    name: Missed OpenAI API Key Warning
    needs: [has_needed_secrets]
    runs-on: ubuntu-latest
    if: ${{ needs.has_needed_secrets.outputs.has_secrets == 'false' }}
    steps:
      - name: Print disabled message
        run: |
          echo "::warning::SDK Library Integration Tests are disabled because OPENAI_API_KEY is not set"

  init_environment:
    name: Build
    needs: [has_needed_secrets]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ needs.has_needed_secrets.outputs.has_secrets == 'true' }}
    outputs:
      LIBS: ${{ steps.init.outputs.LIBS }}

    steps:
      - name: Make LIBS variable global (workaround for cron)
        id: init
        run: |
          echo "LIBS=${{ env.LIBS }}" >> $GITHUB_OUTPUT

  openai_tests:
    needs: [init_environment]
    if: contains(fromJSON('["openai", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-openai-tests.yml
    with:
      # Run expensive tests on weekly schedule (Sunday) or when manually requested
      run_expensive_tests: ${{ (github.event_name == 'schedule' && github.event.schedule == '0 0 * * 0') || github.event.inputs.run_expensive_tests == 'true' }}
    secrets: inherit
  
  langchain_tests:
    needs: [init_environment]
    if: contains(fromJSON('["langchain", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-langchain-tests.yml
    secrets: inherit
  
  langchain_legacy_tests:
    needs: [init_environment]
    if: contains(fromJSON('["langchain_legacy", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-langchain-legacy-tests.yml
    secrets: inherit
  
  llama_index_tests:
    needs: [init_environment]
    if: contains(fromJSON('["llama_index", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-llama-index-tests.yml
    secrets: inherit

  anthropic_tests:
    needs: [init_environment]
    if: contains(fromJSON('["anthropic", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-anthropic-tests.yml
    secrets: inherit

  aisuite_tests:
    needs: [init_environment]
    if: contains(fromJSON('["aisuite", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-aisuite-tests.yml
    secrets: inherit

  haystack_tests:
    needs: [init_environment]
    if: contains(fromJSON('["haystack", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-haystack-tests.yml
    secrets: inherit

  guardrails_tests:
    needs: [init_environment]
    if: contains(fromJSON('["guardrails", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-guardrails-tests.yml
    secrets: inherit

  dspy_tests:
    needs: [init_environment]
    if: contains(fromJSON('["dspy", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-dspy-tests.yml
    secrets: inherit

  crewai_v0_tests:
    needs: [init_environment]
    if: contains(fromJSON('["crewai_v0", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-crewai-v0-tests.yml
    secrets: inherit

  crewai_v1_tests:
    needs: [init_environment]
    if: contains(fromJSON('["crewai_v1", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-crewai-v1-tests.yml
    secrets: inherit
  
  genai_tests:
    needs: [init_environment]
    if: contains(fromJSON('["genai", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-genai-tests.yml
    with:
      # Run expensive tests on weekly schedule (Sunday) or when manually requested
      run_expensive_tests: ${{ (github.event_name == 'schedule' && github.event.schedule == '0 0 * * 0') || github.event.inputs.run_expensive_tests == 'true' }}
    secrets: inherit

  adk_tests:
    needs: [init_environment]
    if: contains(fromJSON('["adk", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-adk-tests.yml
    secrets: inherit

  adk_legacy_1_3_0_tests:
    needs: [init_environment]
    if: contains(fromJSON('["adk_legacy_1_3_0", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-adk-legacy-1-3-0-tests.yml
    secrets: inherit

  evaluation_metrics_tests:
    needs: [init_environment]
    if: contains(fromJSON('["metrics", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-metrics-with-llm-judge-tests.yml
    secrets: inherit

  bedrock_tests:
    needs: [init_environment]
    if: contains(fromJSON('["bedrock", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-bedrock-tests.yml
    secrets: inherit

  litellm_tests:
    needs: [init_environment]
    if: contains(fromJSON('["litellm", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-litellm-tests.yml
    secrets: inherit

  harbor_tests:
    needs: [init_environment]
    if: contains(fromJSON('["harbor", "all"]'), needs.init_environment.outputs.LIBS)
    uses: ./.github/workflows/lib-harbor-tests.yml
    secrets: inherit

  # ========================================
  # Slack Notification (scheduled runs only)
  # ========================================
  notify-slack:
    name: "Slack Notification"
    runs-on: ubuntu-latest
    # Run after all test jobs complete, only on scheduled runs
    needs:
      - openai_tests
      - langchain_tests
      - langchain_legacy_tests
      - llama_index_tests
      - anthropic_tests
      - aisuite_tests
      - haystack_tests
      - guardrails_tests
      - dspy_tests
      - crewai_v0_tests
      - crewai_v1_tests
      - genai_tests
      - adk_tests
      - adk_legacy_1_3_0_tests
      - evaluation_metrics_tests
      - bedrock_tests
      - litellm_tests
      - harbor_tests
    if: |
      always() &&
      github.event_name == 'schedule' &&
      (
        needs.openai_tests.result == 'failure' ||
        needs.langchain_tests.result == 'failure' ||
        needs.langchain_legacy_tests.result == 'failure' ||
        needs.llama_index_tests.result == 'failure' ||
        needs.anthropic_tests.result == 'failure' ||
        needs.aisuite_tests.result == 'failure' ||
        needs.haystack_tests.result == 'failure' ||
        needs.guardrails_tests.result == 'failure' ||
        needs.dspy_tests.result == 'failure' ||
        needs.crewai_v0_tests.result == 'failure' ||
        needs.crewai_v1_tests.result == 'failure' ||
        needs.genai_tests.result == 'failure' ||
        needs.adk_tests.result == 'failure' ||
        needs.adk_legacy_1_3_0_tests.result == 'failure' ||
        needs.evaluation_metrics_tests.result == 'failure' ||
        needs.bedrock_tests.result == 'failure' ||
        needs.litellm_tests.result == 'failure' ||
        needs.harbor_tests.result == 'failure'
      )

    steps:
      - name: "Check Slack configuration"
        id: check-slack
        run: |
          if [ -z "${{ env.SLACK_WEBHOOK_URL }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::SLACK_WEBHOOK_URL not configured - Slack notification will be skipped"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: "Collect failed test suites"
        id: collect-failures
        run: |
          FAILED_SUITES=""
          
          # Check each test suite and collect failures
          if [ "${{ needs.openai_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ OpenAI\n"
          fi
          if [ "${{ needs.langchain_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ LangChain\n"
          fi
          if [ "${{ needs.langchain_legacy_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ LangChain Legacy\n"
          fi
          if [ "${{ needs.llama_index_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ LlamaIndex\n"
          fi
          if [ "${{ needs.anthropic_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ Anthropic\n"
          fi
          if [ "${{ needs.aisuite_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ AISuite\n"
          fi
          if [ "${{ needs.haystack_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ Haystack\n"
          fi
          if [ "${{ needs.guardrails_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ Guardrails\n"
          fi
          if [ "${{ needs.dspy_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ DSPy\n"
          fi
          if [ "${{ needs.crewai_v0_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ CrewAI v0\n"
          fi
          if [ "${{ needs.crewai_v1_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ CrewAI v1\n"
          fi
          if [ "${{ needs.genai_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ GenAI\n"
          fi
          if [ "${{ needs.adk_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ ADK\n"
          fi
          if [ "${{ needs.adk_legacy_1_3_0_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ ADK Legacy 1.3.0\n"
          fi
          if [ "${{ needs.evaluation_metrics_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ Evaluation Metrics\n"
          fi
          if [ "${{ needs.bedrock_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ Bedrock\n"
          fi
          if [ "${{ needs.litellm_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ LiteLLM\n"
          fi
          if [ "${{ needs.harbor_tests.result }}" == "failure" ]; then
            FAILED_SUITES="${FAILED_SUITES}â€¢ Harbor\n"
          fi
          
          # Count failures
          FAILURE_COUNT=$(echo -e "$FAILED_SUITES" | grep -c "â€¢" || echo "0")
          
          # Store in outputs (escape newlines for GitHub Actions)
          echo "failed_suites<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAILED_SUITES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT

      - name: "Send Slack notification"
        if: steps.check-slack.outputs.configured == 'true'
        run: |
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref_name }}"
          FAILURE_COUNT="${{ steps.collect-failures.outputs.failure_count }}"
          FAILED_SUITES="${{ steps.collect-failures.outputs.failed_suites }}"
          
          # Determine schedule type
          if [ "${{ github.event.schedule }}" == "0 0 * * 0" ]; then
            SCHEDULE_TYPE="Weekly (with expensive tests)"
          else
            SCHEDULE_TYPE="Daily"
          fi
          
          # Build Slack payload
          cat << 'PAYLOAD_EOF' > payload.json
          {
            "attachments": [
              {
                "color": "danger",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âŒ Python SDK Integration Tests Failed",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Schedule:*\n__SCHEDULE_TYPE__"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch:*\n`__BRANCH__`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Failed Suites:*\n__FAILURE_COUNT__ test suite(s)"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Failed Test Suites:*\n__FAILED_SUITES__"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ðŸ” View Workflow Run",
                          "emoji": true
                        },
                        "url": "__WORKFLOW_URL__",
                        "style": "primary"
                      }
                    ]
                  }
                ]
              }
            ]
          }
          PAYLOAD_EOF
          
          # Replace placeholders
          sed -i "s|__SCHEDULE_TYPE__|$SCHEDULE_TYPE|g" payload.json
          sed -i "s|__BRANCH__|$BRANCH|g" payload.json
          sed -i "s|__FAILURE_COUNT__|$FAILURE_COUNT|g" payload.json
          sed -i "s|__WORKFLOW_URL__|$WORKFLOW_URL|g" payload.json
          
          # Handle multiline failed suites (replace newlines with \n for JSON)
          FAILED_SUITES_ESCAPED=$(echo "$FAILED_SUITES" | sed ':a;N;$!ba;s/\n/\\n/g')
          sed -i "s|__FAILED_SUITES__|$FAILED_SUITES_ESCAPED|g" payload.json
          
          # Send notification
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H 'Content-type: application/json' \
            --data @payload.json \
            "${{ env.SLACK_WEBHOOK_URL }}")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Slack notification sent successfully"
          else
            echo "âš ï¸ Slack notification failed with HTTP code: $HTTP_CODE"
            cat payload.json
          fi

      - name: "Slack not configured"
        if: steps.check-slack.outputs.configured != 'true'
        run: |
          echo "## Slack Notification Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Slack notifications are not configured. Set the ACTION_MONITORING_SLACK secret to enable them." >> $GITHUB_STEP_SUMMARY