name: "Build Docker Images Multi-Arch ${{ github.event.inputs.image }}"

on:
  workflow_call:
    inputs:
      image:
        type: string
        required: true
        description: Docker Image
      version:
        type: string
        required: true
        description: Version
      build_from:
        type: string
        required: true
        description: Original version to build from 
        default: ""
      build_comet_image:
        type: boolean
        required: true
        description: If to build a Comet integration image
        default: false
      comet_build_args:
        type: string
        required: false
        default: ""
        description: Arguments for cloud docker build
      is_release:
        type: boolean
        required: true
        description: If this is a release build (will build multi-arch and push latest tag)
        default: false
    secrets:
      OPIK_FE_SENTRY_DSN:
        required: false
  workflow_dispatch:
    inputs:
      image:
        type: string
        required: true
        description: Docker Image
      version:
        type: string
        required: true
        description: Version
      build_from:
        type: string
        required: true
        description: Original version to build from 
        default: ""
      build_comet_image:
        type: boolean
        required: true
        description: If to build a Comet integration image
        default: false
      comet_build_args:
        type: string
        required: false
        default: ""
        description: Arguments for cloud docker build
      is_release:
        type: boolean
        required: true
        description: If this is a release build (will build multi-arch and push latest tag)
        default: false

env:
  DOCKER_REGISTRY: "ghcr.io/comet-ml/opik"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - image_type: regular
            image_suffix: ""
            platform: amd64
          - image_type: regular
            image_suffix: ""
            platform: arm64
            skip_guardrails: true
          - image_type: comet
            image_suffix: "-comet"
            platform: amd64
          - image_type: comet
            image_suffix: "-comet"
            platform: arm64
            skip_guardrails: true
    runs-on: ${{ matrix.platform == 'amd64' && 'ubuntu-latest' || 'ubuntu-24.04-arm' }}
    name: ${{ matrix.platform }} ${{ inputs.image }}${{ matrix.image_suffix }}
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      image_name: ${{ steps.set_vars.outputs.image_name }}
    timeout-minutes: 60
    steps:
      - name: Check if job should run
        id: check
        run: |
          SHOULD_RUN="false"
          if [[ "${{ matrix.image_type }}" == "regular" ]] || [[ "${{ inputs.build_comet_image }}" == "true" ]]; then
            if [[ "${{ matrix.platform }}" != "arm64" ]] || [[ "${{ matrix.skip_guardrails }}" != "true" ]] || [[ "${{ inputs.image }}" != "opik-guardrails-backend" ]]; then
              SHOULD_RUN="true"
            fi
          fi
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
      
      - name: Set image variables
        id: set_vars
        if: steps.check.outputs.should_run == 'true'
        run: |
          if [[ "${{ matrix.image_type }}" == "comet" ]]; then
            IMAGE_NAME="${{ inputs.image }}-comet"
          else
            IMAGE_NAME="${{ inputs.image }}"
          fi
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ inputs.build_from }}

      - name: Save opik-sandbox-executor-python
        if: steps.check.outputs.should_run == 'true' && inputs.image == 'opik-python-backend'
        run: |
          docker pull ${{env.DOCKER_REGISTRY}}/opik-sandbox-executor-python:${{inputs.version}}
          docker save ${{env.DOCKER_REGISTRY}}/opik-sandbox-executor-python:${{inputs.version}} | gzip > apps/opik-python-backend/opik-sandbox-executor-python.tar.gz

      - name: Login to GHCR
        if: steps.check.outputs.should_run == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        if: steps.check.outputs.should_run == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        if: steps.check.outputs.should_run == 'true'
        id: build
        uses: docker/build-push-action@v6
        with:
          context: apps/${{ inputs.image }}/
          platforms: linux/${{ matrix.platform }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }}:${{ inputs.is_release && 'latest' || 'main' }}
          provenance: false
          load: true
          outputs: type=image,name=${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }},push-by-digest=true,name-canonical=true,push=true
          build-args: |
            OPIK_VERSION=${{ inputs.version }}
            ${{ matrix.image_type == 'comet' && inputs.comet_build_args || '' }}
            ${{ matrix.image_type == 'comet' && 'SENTRY_ENABLED=true' || '' }}
            ${{ matrix.image_type == 'comet' && format('SENTRY_DSN={0}', secrets.OPIK_FE_SENTRY_DSN) || '' }}
          secrets: |
            ${{ matrix.image_type == 'comet' && format('OPIK_FE_SENTRY_DSN={0}', secrets.OPIK_FE_SENTRY_DSN) || '' }}
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}

      - name: Verify and Export digest
        if: steps.check.outputs.should_run == 'true'
        run: |
          mkdir -p /tmp/digests/${{ steps.set_vars.outputs.image_name }}
          digest="${{ steps.build.outputs.digest }}"
          if [ -z "$digest" ]; then
            echo "ERROR: Digest is empty!"
            exit 1
          fi
          echo "Raw digest from build: $digest"
          
          # Remove sha256: prefix if present, otherwise use as-is
          if [[ "$digest" == sha256:* ]]; then
            HASH="${digest#sha256:}"
          else
            HASH="$digest"
          fi
          
          # Verify image was loaded locally (from load: true)
          # This confirms the build succeeded and image is available
          if docker images --format "{{.ID}}" | grep -q .; then
            IMAGE_COUNT=$(docker images --format "{{.ID}}" | wc -l)
            echo "✓ Image loaded locally (${IMAGE_COUNT} image(s) in daemon)"
          else
            echo "⚠ No images found locally, but push succeeded (digest available)"
          fi
          
          # Verify digest format is valid
          if [ ${#HASH} -eq 64 ] && [[ "$HASH" =~ ^[a-f0-9]+$ ]]; then
            echo "✓ Digest hash format is valid: $HASH"
          else
            echo "ERROR: Invalid digest hash format: $HASH"
            exit 1
          fi
          
          echo "$HASH" > "/tmp/digests/${{ steps.set_vars.outputs.image_name }}/${{ matrix.platform }}.digest"
          echo "✓ Saved digest hash: $HASH"

      - name: Upload digest
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ steps.set_vars.outputs.image_name }}-${{ matrix.platform }}
          path: /tmp/digests/${{ steps.set_vars.outputs.image_name }}/*
          if-no-files-found: error
          retention-days: 1

  merge:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - image_type: regular
            image_suffix: ""
          - image_type: comet
            image_suffix: "-comet"
    steps:
      - name: Check if job should run
        id: check
        run: |
          SHOULD_RUN="false"
          if [[ "${{ matrix.image_type }}" == "regular" ]] || [[ "${{ inputs.build_comet_image }}" == "true" ]]; then
            SHOULD_RUN="true"
          fi
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
      
      - name: Set image variables
        id: set_vars
        if: steps.check.outputs.should_run == 'true'
        run: |
          if [[ "${{ matrix.image_type }}" == "comet" ]]; then
            IMAGE_NAME="${{ inputs.image }}-comet"
          else
            IMAGE_NAME="${{ inputs.image }}"
          fi
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Download digests
        if: steps.check.outputs.should_run == 'true'
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests/${{ steps.set_vars.outputs.image_name }}
          pattern: digests-${{ steps.set_vars.outputs.image_name }}-*
          merge-multiple: true

      - name: Set up Docker Buildx
        if: steps.check.outputs.should_run == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.check.outputs.should_run == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manifest list and push tags
        if: steps.check.outputs.should_run == 'true'
        run: |
          cd /tmp/digests/${{ steps.set_vars.outputs.image_name }}
          
          # Debug: Show directory structure
          echo "Directory structure:"
          find . -type f | sort
          
          # Collect all digests (already verified during push)
          DIGESTS=""
          while IFS= read -r digest_file; do
            if [ -f "$digest_file" ]; then
              DIGEST_VALUE=$(cat "$digest_file" | tr -d '\n\r ' | xargs)
              if [ -n "$DIGEST_VALUE" ] && [ ${#DIGEST_VALUE} -eq 64 ]; then
                DIGEST_REF="${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }}@sha256:$DIGEST_VALUE"
                echo "Found digest: $digest_file -> $DIGEST_REF"
                DIGESTS="$DIGESTS $DIGEST_REF"
              else
                echo "ERROR: Invalid digest value in $digest_file: '$DIGEST_VALUE'"
                exit 1
              fi
            fi
          done < <(find . -name "*.digest" -type f | sort)
          
          if [ -z "$DIGESTS" ]; then
            echo "ERROR: No digests found!"
            echo "Searched for *.digest files in: $(pwd)"
            find . -type f -name "*.digest" || echo "No .digest files found"
            exit 1
          fi
          
          echo ""
          echo "Collected verified digests: $DIGESTS"
          
          # Build tags
          TAGS="${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }}:${{ inputs.version }}"
          if [[ "${{ inputs.is_release }}" == "true" ]]; then
            TAGS="$TAGS ${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }}:latest"
          fi
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="$TAGS ${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }}:main"
          fi
          
          # Create and push manifest
          TAG_ARGS=""
          for tag in $TAGS; do
            TAG_ARGS="$TAG_ARGS -t $tag"
          done
          
          echo ""
          echo "Creating manifest with tags: $TAG_ARGS"
          echo "Using digests: $DIGESTS"
          docker buildx imagetools create $TAG_ARGS $DIGESTS

      - name: Write Build Summary
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "### Docker images pushed: ${{ steps.set_vars.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }}:${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.is_release }}" == "true" ]]; then
            echo "${{ env.DOCKER_REGISTRY }}/${{ steps.set_vars.outputs.image_name }}:latest" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ inputs.image }}" == "opik-guardrails-backend" ]]; then
              echo "Built for platforms: linux/amd64" >> $GITHUB_STEP_SUMMARY
            else
              echo "Built for platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "Built for platforms: linux/amd64" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- [View on GitHub Container Registry](https://github.com/${{ github.repository }}/pkgs/container/opik%2F${{ steps.set_vars.outputs.image_name }})" >> $GITHUB_STEP_SUMMARY

